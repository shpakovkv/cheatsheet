Установка GPIB драйверов
========================

Подробное описание процесса установки GPIB драйверов для контроллеров двух типов (PCIe и USB) на системы CentOS 7 и Ubuntu 16.04LTS.


Доступ к GPIB драйверу из python
--------------------------------

Перед установкой GPIB драйверов можно установить python.boost (для возможности использовать python для управления GPIB устройствами через С++ библиотеки).

```
# для CentOS
sudo yum install epel-release
sudo yum install boost boost-thread boost-devel

# для Ubuntu
sudo apt-get install libboost-all-dev
```

*Примечание: под CentOS 7 не прокатило,- python package не скомпилировался и библиотека gpib в python недоступна.*

Установка GPIB драйвера
-----------------------

Полезные ссылки: http://www.anderswallin.net/2013/11/gpib-on-linux/

##### Подготовка к установке драйверов
Для сборки драйверов нужны исходники ядра линукс той же версии, что и установленный linux. Все ядро не нужно, достаточно установить заголовочные файлы ядра (header files). Для CentOS:

```
# узнать версию ядра линукса:
uname -r

# установка CentOS:
sudo yum install kernel-devel

# установка Ubuntu:
sudo apt-get install linux-headers-$(uname -r)
```

Файлы установятся в папку ```/usr/src/kernels/$(uname -r)```.

##### Скачивание и установка

Скачиваем и распаковываем **подходящую** версию драйверов gpib с сайта https://sourceforge.net/projects/linux-gpib/. Версия драйверов **должна** поддерживать установленную версию ядра линукс (см. описание версий на сайте). Если ОС новая, то последняя версия драйвера скорей всего подойдет.

Настраиваем установку командой (из корневой папки драйверов), компилируем исходники и устанавливаем:


```
./configure --with-linux-srcdir=/usr/src/kernels/$(uname -r)
make
sudo make install
```

##### Правим пути до библиотек (при необходимости)

Библиотека **libgpib.so.0** при установке GPIB драйверов должна установиться в ```/lib```, но может установиться в ```/usr/local/lib```. Находим расположение библиотеки:

```
locate libgpib.so.0
```

если она не в папке **/lib/**, то создаем символьную ссылку на нее, чтобы программа смогла ее найти:

```
cd /lib
sudo ln -s /usr/local/lib/libgpib.so.0 libgpib.so.0

# где /usr/local/lib/libgpib.so.0 - путь до библиотеки, найденный ранее
```

##### Если библиотека libgpib.so.0 не находится
Если в Ubuntu используется шифрование системных файлов или директории home, то команда locate может не находить некоторые файлы. Чтобы это изменить, необходимо подредактировать исключения в базе данных поиска.

* Открываем файл ```/etc/updatedb.conf``` и в строке ```PRUNEFS="...``` удаляем ключевое слово ```ecryptfs```.
* Сохраняем файл.
* Удаляем старую базу данных поиска и генерируем новую:

  ```
  sudo rm /var/lib/mlocate/mlocate.db
  sudo updatedb
  ```

##### Настройка драйверов

Открыть файл ```/etc/gpib.conf``` и убедиться, что в разделе **"interface"** параметру **"board_type"** присвоено значение **"ni_pci"** (при использовании платы **NI PCIe-GPIB**). При использовании интерфейса **USB-GPIB** должно стоять **"ni_usb_b"**.

В разделе "**interface**" прописать параметры:

* **name** = надо присвоить имя устройству, чтоб проще было к нему подключаться (например: "gpib0", "interface")

* **pad** = 0  - адрес на gpib шине (ставим 0 для gpib контроллера)

* **sad** = 0  - вторичный адрес устройства, оставляем 0

Для каждого подключаемого устройства создать (или скопировать имеющийся) раздел **device**. В каждом таком разделе прописать параметры подключаемого устройства:

* **name** = можно присвоить имя устройству, чтобы проще было к нему подключаться (например: scope, hivoltage, voltmeter, ...)

* **pad** = адрес gpib устройства (от 1 до 15), прописывается тут и в настройках gpib самого устройства

* **sad** = 0  - вторичный адрес устройства, оставляем 0

* остальные параметры можно не трогать и просто копировать, как в образце (файле, сгенерированном автоматически при установке драйверов).

##### Загрузка модуля в ядро линукс
Необходимо загрузить модуль для поддержки GPIB контроллера (после всех предыдущих действий данный модуль уже будет в системе, но не загружен в ядро и не используется):

```
# для платы NI PCIe-GPIB
sudo modprobe tnt4882

# для контроллера NI GPIB-USB-HS
sudo modprobe ni_usb_gpib
```

Необходимо запускать эту команду при каждом перезапуске ОС. Или настроить автозагрузку этого модуля при запуске ОС:

```
# Создать файл:
/etc/modules-load.d/tnt4882.conf

# Записать в файл имя модуля:
tnt4882
```

Аналогично настраивается автозагрузка модуля **ni_usb_gpib**.

После этого модуль будет загружаться автоматически. Проверить, загружен ли модуль можно командой:

```
lsmod | grep tnt4882
# или
lsmod | grep ni_usb_gpib
```

Изначально модуль tnt4882 поддерживал чип National Instruments TNT4882, но, похоже, более поздний TNT5004 тоже поддерживается. В таблице в явном виде не указана плата NI PCIe-GPIB, но, скорей всего, здесь не делают отличи между PCIe-GPIB и PCI-GPIB:
https://linux-gpib.sourceforge.io/doc_html/supported-hardware.html#HARDWARE-MATRIX

Здесь есть информация об отличиях чипов TNT4882 и TNT5004 с точки зрения драйверов:
https://forums.ni.com/t5/Instrument-Control-GPIB-Serial/Differences-between-TNT4882-and-TNT5004-for-an-OS-driver-writer/td-p/1060813

##### Запуск настройки драйвера

При этом происходит считывание параметров из файла gpib.conf:

```
sudo /usr/local/sbin/gpib_config --minor 0
# "--minor 0" указывает на адрес контроллера на gpib шине
```

эту команду необходимо выполнять после каждого редактирования файла gpib.conf

##### Необходимо изменить свойства интерфейса:

```
sudo chmod a+rw /dev/gpib0
```

Проверка работоспособности драйвера:
------------------------------------

* После установки перезагрузить комп
* Подключить и включить gpib устройство

**Проверка платы:**

1. В терминале набрать ```ibtest```
2. Ввести: ```b```
3. Ввести имя платы (см. файл gpib.conf раздел "interface" параметр "name")
4. Ввести: ```l```
   Если на экран выводятся параметры gpib подключения (dav, eoi, ndac, и другие), значит все нормально.
5. Для выхода ввести: ```q```

**Проверка GPIB устройства**
Перед проверкой устройства, не забудьте подключить его к GPIB шине, включить его и настроить (однократно) GPIB адрес (для более подробной информации см. руководство пользователя для используемого устройства).
1. В терминале набрать ```ibtest```
2. Ввести: ```d```
3. Ввести адрес устройства на gpib шине (адрес должен быть прописан в настройках GPIB самого устройства, а также на компьютере в файле gpib.conf в одном из разделов "device" - параметр "pad")
4. Для отправки команды устройству ввести: ```w```
5. Ввести команду: ```*IDN?```
6. Для получения ответа ввести: ```r```
7. Ввести количество считываемых байт: ```1024``` Если все настроено и работает правильно, то выведется название и модель устройства (в строке "received string:")
5. Для выхода ввести: ```q```

---------------------------------------------

###### <div style="text-align: right"> Шпаков Константин, август 2018 </div>
